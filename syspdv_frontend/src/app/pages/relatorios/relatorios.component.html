<p-toast></p-toast>
<div class="card">
  <h2>Relatório de Vendas</h2>

  <div class="p-fluid grid formgrid mb-4 p-3 surface-100 border-round">
    <div class="field col-12 md:col-3">
      <label for="dataInicio">Data Início</label>
      <p-calendar id="dataInicio" [(ngModel)]="filtroDataInicio" [showTime]="true" dateFormat="dd/mm/yy"></p-calendar>
    </div>
    <div class="field col-12 md:col-3">
      <label for="dataFim">Data Fim</label>
      <p-calendar id="dataFim" [(ngModel)]="filtroDataFim" [showTime]="true" dateFormat="dd/mm/yy"></p-calendar>
    </div>
    <div class="field col-12 md:col-3">
      <label for="usuario">Usuário (Operador)</label>
      <p-dropdown id="usuario" [options]="usuarios" [(ngModel)]="filtroUsuarioId"
                  optionLabel="nomeCompleto" optionValue="id"
                  [showClear]="true" placeholder="Todos"></p-dropdown>
    </div>
    <div class="field col-6 md:col-1">
      <label for="valorMin">Valor Min (R$)</label>
      <p-inputNumber id="valorMin" [(ngModel)]="filtroValorMin" mode="currency" currency="BRL" locale="pt-BR"></p-inputNumber>
    </div>
    <div class="field col-6 md:col-1">
      <label for="valorMax">Valor Max (R$)</label>
      <p-inputNumber id="valorMax" [(ngModel)]="filtroValorMax" mode="currency" currency="BRL" locale="pt-BR"></p-inputNumber>
    </div>
    <div class="field col-12 md:col-1 flex align-items-end">
      <p-button icon="pi pi-filter" (onClick)="carregarVendas()"></p-button>
    </div>
    <div class="field col-12 md:col-1 flex align-items-end">
      <p-button icon="pi pi-filter-slash" styleClass="p-button-outlined" (onClick)="limparFiltros()"></p-button>
    </div>
  </div>

  <div class="grid mb-4">
    <div class="col-4">
      <div class="p-3 border-round surface-card text-center">
        <div class="text-xl text-color-secondary">Total de Vendas (R$)</div>
        <div class="text-3xl font-bold text-primary">{{ totalVendasValor | currency:'BRL' }}</div>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 border-round surface-card text-center">
        <div class="text-xl text-color-secondary">Nº de Vendas</div>
        <div class="text-3xl font-bold">{{ totalVendasCount }}</div>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 border-round surface-card text-center">
        <div class="text-xl text-color-secondary">Itens Vendidos</div>
        <div class="text-3xl font-bold">{{ totalItensVendidos | number:'1.0-0' }}</div>
      </div>
    </div>
  </div>

  <p-table [value]="vendas" [tableStyle]="{'min-width': '50rem'}">
    <ng-template pTemplate="header">
      <tr>
        <th>ID Venda</th>
        <th>Data/Hora</th>
        <th>Operador</th>
        <th>Valor Total</th>
        <th>Recebido</th>
        <th>Troco</th>
        <th style="width: 8rem">Ações</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-venda>
      <tr>
        <td>{{ venda.id }}</td>
        <td>{{ venda.dataHora | date:'dd/MM/yy HH:mm' }}</td>
        <td>{{ venda.usuario.nomeCompleto }}</td>
        <td><strong>{{ venda.valorTotal | currency:'BRL' }}</strong></td>
        <td>{{ venda.valorRecebido | currency:'BRL' }}</td>
        <td>{{ venda.troco | currency:'BRL' }}</td>
        <td>
          <p-button icon="pi pi-search" styleClass="p-button-rounded p-button-info" pTooltip="Ver Itens" (onClick)="verDetalhes(venda)"></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center">Nenhuma venda encontrada para os filtros aplicados.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog [(visible)]="dialogVisivel" header="Detalhes da Venda (ID: {{vendaSelecionada?.id}})" [modal]="true" [style]="{width: '600px'}">
  <div *ngIf="vendaSelecionada" class="recibo">
    <p>Data: {{ vendaSelecionada.dataHora | date:'dd/MM/yyyy HH:mm:ss' }}</p>
    <p>Operador: {{ vendaSelecionada.usuario.nomeCompleto }}</p>

    <h4 class="mt-4">Itens Vendidos</h4>
    <p-table [value]="vendaSelecionada.itens">
      <ng-template pTemplate="header">
        <tr>
          <th>Produto</th>
          <th>Cód.</th>
          <th>Qtd.</th>
          <th>Preço Unit.</th>
          <th>Subtotal</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.produto.nome }}</td>
          <td>{{ item.produto.codigo }}</td>
          <td>{{ item.quantidade }}</td>
          <td>{{ item.precoUnitario | currency:'BRL' }}</td>
          <td><strong>{{ item.subtotal | currency:'BRL' }}</strong></td>
        </tr>
      </ng-template>
    </p-table>

    <div class="recibo-totais mt-4">
      <div><span>Total:</span> <strong>{{ vendaSelecionada.valorTotal | currency:'BRL' }}</strong></div>
      <div><span>Recebido:</span> <strong>{{ vendaSelecionada.valorRecebido | currency:'BRL' }}</strong></div>
      <div><span>Troco:</span> <strong>{{ vendaSelecionada.troco | currency:'BRL' }}</strong></div>
    </div>
  </div>
</p-dialog>
