<p-toast></p-toast>

<div class="card">
  <p-table [value]="produtos" [tableStyle]="{'min-width': '50rem'}" [paginator]="true" [rows]="10">
    <ng-template pTemplate="caption">
      <div class="table-header-container flex flex-column md:flex-row justify-content-between align-items-center gap-2">
        <h2 class="m-0">Gestão de Estoque</h2>
        <div class="flex gap-2 w-full md:w-auto">
          <p-inputGroup class="w-full">
            <input pInputText placeholder="Buscar por Código" [formControl]="searchControl"
              (keyup.enter)="buscarProduto()" />
            <button pButton icon="pi pi-search" (onClick)="buscarProduto()" pTooltip="Buscar"
              tooltipPosition="top"></button>
            <button pButton icon="pi pi-refresh" (onClick)="limparBusca()" styleClass="p-button-outlined"
              pTooltip="Limpar Busca" tooltipPosition="top"></button>
          </p-inputGroup>
          <p-button icon="pi pi-plus" label="Novo" (onClick)="abrirDialogNovo()"
            styleClass="white-space-nowrap"></p-button>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Código</th>
        <th>Nome</th>
        <th>Categoria</th>
        <th>Preço (R$)</th>
        <th>Estoque</th>
        <th style="width: 12rem" class="text-center">Ações</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-prod>
      <tr>
        <td>{{ prod.codigo }}</td>
        <td>{{ prod.nome }}</td>
        <td>{{ prod.categoria }}</td>
        <td>{{ prod.precoUnitario | currency:'BRL' }}</td>
        <td>
          <span [class.text-red-500]="prod.quantidadeEstoque <= 5" [class.font-bold]="prod.quantidadeEstoque <= 5">
            {{ prod.quantidadeEstoque }}
          </span>
        </td>
        <td class="text-center">
          <div class="flex justify-content-center gap-2">

            <p-button icon="pi pi-arrows-h" pTooltip="Movimentar" tooltipPosition="top" [rounded]="true" [text]="true"
              severity="info" (onClick)="abrirDialogAjuste(prod)">
            </p-button>

            <p-button icon="pi pi-history" pTooltip="Histórico" tooltipPosition="top" [rounded]="true" [text]="true"
              severity="help" (onClick)="abrirHistorico(prod)">
            </p-button>

            <p-button icon="pi pi-pencil" pTooltip="Editar" tooltipPosition="top" [rounded]="true" [text]="true"
              severity="success" (onClick)="abrirDialogEditar(prod)">
            </p-button>

            <p-button icon="pi pi-trash" pTooltip="Excluir" tooltipPosition="top" [rounded]="true" [text]="true"
              severity="danger" (onClick)="excluirProduto(prod.id)">
            </p-button>

          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center p-4">Nenhum produto encontrado.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog [(visible)]="dialogVisivel" [header]="isEditMode ? 'Editar Produto' : 'Novo Produto'" [modal]="true"
  [style]="{width: '600px'}" (onHide)="fecharDialog()">
  <form [formGroup]="produtoForm" (ngSubmit)="salvarProduto()">
    <div class="p-fluid p-formgrid grid">

      <div class="field col-12 md:col-6">
        <label for="codigo">Código</label>
        <input pInputText id="codigo" formControlName="codigo" />
        <small class="p-error block" *ngIf="f['codigo'].invalid && f['codigo'].touched">Código é obrigatório.</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="categoria">Categoria</label>
        <input pInputText id="categoria" formControlName="categoria" />
        <small class="p-error block" *ngIf="f['categoria'].invalid && f['categoria'].touched">Categoria é
          obrigatória.</small>
      </div>

      <div class="field col-12">
        <label for="nome">Nome do Produto</label>
        <input pInputText id="nome" formControlName="nome" />
        <small class="p-error block" *ngIf="f['nome'].invalid && f['nome'].touched">Nome é obrigatório.</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="precoUnitario">Preço Unitário</label>
        <p-inputNumber id="precoUnitario" formControlName="precoUnitario" mode="currency" currency="BRL"
          locale="pt-BR"></p-inputNumber>
        <small class="p-error block" *ngIf="f['precoUnitario'].invalid && f['precoUnitario'].touched">Obrigatório (>
          0).</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="quantidadeEstoque">Qtd. Inicial</label>
        <p-inputNumber id="quantidadeEstoque" formControlName="quantidadeEstoque" [min]="0"></p-inputNumber>
        <small class="p-error block"
          *ngIf="f['quantidadeEstoque'].invalid && f['quantidadeEstoque'].touched">Obrigatório (>= 0).</small>
      </div>

    </div>

    <div class="p-dialog-footer mt-4">
      <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (onClick)="fecharDialog()"></p-button>
      <p-button label="Salvar" icon="pi pi-check" type="submit"></p-button>
    </div>
  </form>
</p-dialog>

<p-dialog [(visible)]="ajusteDialogVisivel" header="Movimentação de Estoque" [modal]="true" [style]="{width: '500px'}"
  (onHide)="fecharDialogAjuste()">

  <div *ngIf="currentProdutoAjuste" class="mb-3 p-3 surface-100 border-round-lg">
    <div class="flex flex-column gap-2">

      <div class="flex align-items-center gap-2">
        <i class="pi pi-tag text-primary text-xl"></i>
        <span class="font-bold text-xl text-900">{{ currentProdutoAjuste.nome }}</span>
      </div>

      <div class="flex align-items-center gap-2">
        <i class="pi pi-box text-primary text-xl"></i>
        <span class="font-medium text-lg text-700">{{ currentProdutoAjuste.quantidadeEstoque }} unidades</span>
      </div>

    </div>
  </div>

  <p-tabView styleClass="w-full">

    <p-tabPanel>
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2">
          <i class="pi pi-plus-circle text-green-500"></i>
          <span class="font-medium">Entrada</span>
        </div>
      </ng-template>

      <form [formGroup]="formRepor" (ngSubmit)="onRepor()" class="mt-3">
        <div class="p-fluid">
          <div class="field">
            <label>Quantidade a Adicionar</label>
            <p-inputNumber formControlName="quantidade" [min]="1" [showButtons]="true" inputId="qtdRepor"
              buttonLayout="horizontal" incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"></p-inputNumber>
            <small class="p-error block"
              *ngIf="formRepor.get('quantidade')?.invalid && formRepor.get('quantidade')?.touched">Obrigatório (mín.
              1)</small>
          </div>
          <div class="field">
            <label>Motivo</label>
            <textarea pInputTextarea formControlName="motivo" rows="3"
              placeholder="Ex: Compra de fornecedor, Devolução..."></textarea>
            <small class="p-error block"
              *ngIf="formRepor.get('motivo')?.invalid && formRepor.get('motivo')?.touched">Mínimo 5 caracteres</small>
          </div>
          <p-button label="Confirmar Entrada" icon="pi pi-check" styleClass="p-button-success w-full mt-2"
            type="submit"></p-button>
        </div>
      </form>
    </p-tabPanel>

    <p-tabPanel>
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2">
          <i class="pi pi-minus-circle text-red-500"></i>
          <span class="font-medium">Saída</span>
        </div>
      </ng-template>

      <form [formGroup]="formBaixar" (ngSubmit)="onBaixar()" class="mt-3">
        <div class="p-fluid">
          <div class="field">
            <label>Quantidade a Remover</label>
            <p-inputNumber formControlName="quantidade" [min]="1" [showButtons]="true" inputId="qtdBaixar"
              buttonLayout="horizontal" incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"></p-inputNumber>
            <small class="p-error block"
              *ngIf="formBaixar.get('quantidade')?.invalid && formBaixar.get('quantidade')?.touched">Obrigatório (mín.
              1)</small>
          </div>
          <div class="field">
            <label>Motivo</label>
            <textarea pInputTextarea formControlName="motivo" rows="3"
              placeholder="Ex: Venda externa, Perda, Avaria..."></textarea>
            <small class="p-error block"
              *ngIf="formBaixar.get('motivo')?.invalid && formBaixar.get('motivo')?.touched">Mínimo 5 caracteres</small>
          </div>
          <p-button label="Confirmar Saída" icon="pi pi-check" styleClass="p-button-danger w-full mt-2"
            type="submit"></p-button>
        </div>
      </form>
    </p-tabPanel>

    <p-tabPanel>
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2">
          <i class="pi pi-pencil text-orange-500"></i>
          <span class="font-medium">Inventário</span>
        </div>
      </ng-template>

      <div
        class="text-sm text-700 mb-4 bg-yellow-50 border-yellow-200 border-1 p-3 border-round flex align-items-start gap-2">
        <i class="pi pi-info-circle text-orange-500 text-xl mt-1"></i>
        <span>Informe a quantidade exata contada na prateleira. O sistema calculará a diferença automaticamente.</span>
      </div>

      <form [formGroup]="formAjuste" (ngSubmit)="onAjustar()" class="mt-3">
        <div class="p-fluid">
          <div class="field">
            <label>Estoque Final (Contagem Física)</label>
            <p-inputNumber formControlName="estoqueFinal" [min]="0" [showButtons]="true" inputId="qtdFinal"
              buttonLayout="horizontal" incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"></p-inputNumber>
            <small class="p-error block"
              *ngIf="formAjuste.get('estoqueFinal')?.invalid && formAjuste.get('estoqueFinal')?.touched">Obrigatório</small>
          </div>
          <div class="field">
            <label>Motivo do Ajuste</label>
            <textarea pInputTextarea formControlName="motivo" rows="3"
              placeholder="Ex: Contagem de inventário, Correção de erro..."></textarea>
            <small class="p-error block"
              *ngIf="formAjuste.get('motivo')?.invalid && formAjuste.get('motivo')?.touched">Mínimo 5 caracteres</small>
          </div>
          <p-button label="Corrigir Estoque" icon="pi pi-check" styleClass="p-button-warning w-full mt-2"
            type="submit"></p-button>
        </div>
      </form>
    </p-tabPanel>

  </p-tabView>
</p-dialog>

<p-dialog [(visible)]="historicoDialogVisivel" header="Histórico de Movimentações" [modal]="true"
  [style]="{width: '700px'}" [draggable]="false" [resizable]="false">

  <div *ngIf="produtoSelecionadoHistorico" class="mb-4 flex align-items-center gap-2">
    <i class="pi pi-box text-xl text-primary"></i>
    <span class="text-900 font-bold text-lg">{{ produtoSelecionadoHistorico.nome }}</span>
    <span class="text-500 ml-2">({{ produtoSelecionadoHistorico.codigo }})</span>
  </div>

  <p-table [value]="historicoMovimentacoes" [loading]="carregandoHistorico" [rows]="5" [paginator]="true"
    styleClass="p-datatable-sm p-datatable-striped">
    <ng-template pTemplate="header">
      <tr>
        <th>Data/Hora</th>
        <th>Tipo</th>
        <th>Qtd.</th>
        <th>Motivo</th>
        <th>Usuário</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-mov>
      <tr>
        <td>{{ mov.dataHora | date:'dd/MM/yy HH:mm' }}</td>
        <td>
          <p-tag [value]="mov.tipo" [severity]="getSeverity(mov.tipo)"></p-tag>
        </td>
        <td class="font-bold" [class.text-green-600]="mov.quantidade > 0" [class.text-red-600]="mov.quantidade < 0">
          {{ mov.quantidade > 0 ? '+' : '' }}{{ mov.quantidade }}
        </td>
        <td>{{ mov.motivo }}</td>
        <td class="text-sm text-600">{{ mov.usuarioNome || '-' }}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center p-4 text-500">
          Nenhuma movimentação registrada.
        </td>
      </tr>
    </ng-template>
  </p-table>

  <div class="p-dialog-footer mt-2">
    <p-button label="Fechar" icon="pi pi-times" (onClick)="historicoDialogVisivel = false"
      styleClass="p-button-text"></p-button>
  </div>
</p-dialog>
